"use strict";(self.webpackChunkstarlake_docs=self.webpackChunkstarlake_docs||[]).push([[5089],{3905:function(e,t,r){r.d(t,{Zo:function(){return u},kt:function(){return d}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var i=n.createContext({}),p=function(e){var t=n.useContext(i),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},u=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(r),d=a,f=m["".concat(i,".").concat(d)]||m[d]||c[d]||o;return r?n.createElement(f,l(l({ref:t},u),{},{components:r})):n.createElement(f,l({ref:t},u))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,l=new Array(o);l[0]=m;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:a,l[1]=s;for(var p=2;p<o;p++)l[p]=r[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},6138:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return i},toc:function(){return p},default:function(){return c}});var n=r(7462),a=r(3366),o=(r(7294),r(3905)),l={sidebar_position:3},s="Transform",i={unversionedId:"howto/transform",id:"howto/transform",isDocsHomePage:!1,title:"Transform",description:"Once your data is ingested, you may start to expose insights by joining them and / or create meaningful aggregates.",source:"@site/docs/howto/transform.md",sourceDirName:"howto",slug:"/howto/transform",permalink:"/starlake/docs/howto/transform",editUrl:"https://github.com/starlake-ai/starlake/edit/master/docs/docs/howto/transform.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"cometSidebar",previous:{title:"Load",permalink:"/starlake/docs/howto/load"},next:{title:"Extract",permalink:"/starlake/docs/examples/extract"}},p=[{value:"Parquet Job",id:"parquet-job",children:[]},{value:"BigQuery Job",id:"bigquery-job",children:[]},{value:"Externalize SQL Requests",id:"externalize-sql-requests",children:[]}],u={toc:p};function c(e){var t=e.components,r=(0,a.Z)(e,["components"]);return(0,o.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"transform"},"Transform"),(0,o.kt)("p",null,"Once your data is ingested, you may start to expose insights by joining them and / or create meaningful aggregates."),(0,o.kt)("p",null,"In the example below, we join the ",(0,o.kt)("inlineCode",{parentName:"p"},"sellers")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"orders")," tables to compute the total amount sold by each seller."),(0,o.kt)("p",null,"We want to do it on parquet files and on BigQuery. We need to create 2 env files, one for environment."),(0,o.kt)("h2",{id:"parquet-job"},"Parquet Job"),(0,o.kt)("p",null,"Create the ",(0,o.kt)("inlineCode",{parentName:"p"},"env.FS.comet.yml")," file in the ",(0,o.kt)("inlineCode",{parentName:"p"},"metadata")," folder as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'env:\n  sink_type: "FS"\n  engine: Spark\n  sellers_view: "FS:${root_path}/datasets/accepted/hr/sellers"\n  orders_view: "FS:${root_path}/datasets/accepted/sales/orders"\n')),(0,o.kt)("p",null,"Create the YAML file that describe the job and name it ",(0,o.kt)("inlineCode",{parentName:"p"},"sellers_kpi.comet.yml"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'transform:\n  name: kpi\n  engine: ${engine}\n  views:\n    sellers: "${sellers_view}"\n    orders: "${orders_view}"\n  tasks:\n    - sql: "select seller_email, sum(amount) as sum from sellers, orders where sellers.id = orders.seller_id group by sellers.seller_email"\n      name: byseller\n      domain: sales_kpi\n      dataset: byseller_kpi\n      write: OVERWRITE\n  area: business\n')),(0,o.kt)("p",null,"Before executing the job, we set the ",(0,o.kt)("inlineCode",{parentName:"p"},"COMET_ENV")," variable to ",(0,o.kt)("inlineCode",{parentName:"p"},"FS")," to make sure variables are instantiated correctly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"export COMET_ENV=FS\n$SPARK_HOME/bin/spark-submit target/scala-2.12/comet-assembly-VERSION.jar job --name sellers_kpi\n")),(0,o.kt)("h2",{id:"bigquery-job"},"BigQuery Job"),(0,o.kt)("p",null,"To execute the same request on BigQuery, we need to create views on the BigQuery tables where data were ingested.\nCreate the ",(0,o.kt)("inlineCode",{parentName:"p"},"env.BQ.comet.yml")," file in the ",(0,o.kt)("inlineCode",{parentName:"p"},"metadata")," folder as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'env:\n  sink_type: "BQ"\n  engine: BQ\n  sellers_view: "BQ:select * from hr.sellers" # or simply sellers_view: hr.sellers\n  orders_view: "BQ:select * from sales.orders" # or simply sellers_view: sales.orders\n')),(0,o.kt)("p",null,"Before executing the job, we set the ",(0,o.kt)("inlineCode",{parentName:"p"},"COMET_ENV")," variable to ",(0,o.kt)("inlineCode",{parentName:"p"},"BQ")," to make sure variables are instantiated correctly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"export COMET_ENV=BQ\n$SPARK_HOME/bin/spark-submit target/scala-2.12/comet-assembly-VERSION.jar job --name sellers_kpi\n")),(0,o.kt)("h2",{id:"externalize-sql-requests"},"Externalize SQL Requests"),(0,o.kt)("p",null,"Most of the time you may want to use your favorite SQL Deve env (I personally use Jetbrains IntelliJ / DataGrip).\nYou may externalize the SQL Code in a file named after the name of the job if you have only one task in the job file\nor after the name and the task for each task in the job file."),(0,o.kt)("p",null,"Create a SQL File with the name ",(0,o.kt)("inlineCode",{parentName:"p"},"ki.byseller.sql")," (or simply ",(0,o.kt)("inlineCode",{parentName:"p"},"ki.sql")," since we have only one task in the job file)"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"select seller_email, sum(amount) as sum from sellers, orders where sellers.id = orders.seller_id\ngroup by sellers.seller_email\n")),(0,o.kt)("p",null,"And leave the task.sql field blank in the YAML file."))}c.isMDXComponent=!0}}]);